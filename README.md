

# SideFormer
## λ³΄ν–‰λ΅ μ„Έκ·Έλ©ν…μ΄μ… λ¨λΈ

μ΄ ν”„λ΅μ νΈλ” `Segformer` λ¨λΈμ„ μ‚¬μ©ν•μ—¬ μ£Όν–‰κ°€λ¥μμ—­κ³Ό κ°μ²΄ (λ„λ΅,λ³΄λ„, μμ „κ±° λ„λ΅, μ μλΈ”λ΅ λ“±) λ‹¤μ–‘ν• λ³΄ν–‰ ν™κ²½ μ”μ†λ¥Ό λ¶„ν• (Segmentation)ν•λ” λ”¥λ¬λ‹ λ¨λΈμ„ ν•™μµν•κ³  μµμ ν™”ν•©λ‹λ‹¤. λ¶„μ‚° λ°μ΄ν„° λ³‘λ ¬ μ²λ¦¬(DDP)λ¥Ό ν™μ©ν•μ—¬ λ‹¤μ¤‘ GPU ν™κ²½μ—μ„ ν¨μ¨μ μΌλ΅ ν•™μµν•λ©°, `Optuna`λ¥Ό μ΄μ©ν•΄ μµμ μ ν•μ΄νΌνλΌλ―Έν„°λ¥Ό νƒμƒ‰ν•©λ‹λ‹¤.

-----

## π μ£Όμ” κΈ°λ¥

  - **λ¶„μ‚° ν•™μµ (DDP)**: `torch.nn.parallel.DistributedDataParallel`μ„ μ‚¬μ©ν•μ—¬ μ—¬λ¬ GPUμ—μ„ λΉ λ¥΄κ³  ν¨μ¨μ μΌλ΅ λ¨λΈμ„ ν•™μµν•©λ‹λ‹¤.
  - **ν•μ΄νΌνλΌλ―Έν„° μµμ ν™”**: `Optuna` λΌμ΄λΈλ¬λ¦¬λ¥Ό ν†µν•΄ μµμ μ ν•™μµλ¥ , λ°°μΉ ν¬κΈ°, μµν‹°λ§μ΄μ € λ“±μ„ μλ™μΌλ΅ νƒμƒ‰ν•©λ‹λ‹¤.
  - **μ μ—°ν• ν•™μµ μ μ–΄**: μ»¤λ§¨λ“ λΌμΈ μΈμλ¥Ό ν†µν•΄ ν•μ΄νΌνλΌλ―Έν„° μµμ ν™”λ¥Ό κ±΄λ„λ›°κ³ , μ €μ¥λ μµμ μ μ„¤μ •μΌλ΅ μµμΆ… ν•™μµμ„ λ°”λ΅ μ‹μ‘ν•  μ μμµλ‹λ‹¤.
  - **ν•™μµ κ³Όμ • λ¨λ‹ν„°λ§**: `wandb` (Weights & Biases)μ™€ μ—°λ™ν•μ—¬ ν•™μµ μ†μ‹¤, κ²€μ¦ μ†μ‹¤, μ •ν™•λ„ λ“±μ μ§€ν‘λ¥Ό μ‹¤μ‹κ°„μΌλ΅ μ‹κ°ν™”ν•κ³  μ¶”μ ν•©λ‹λ‹¤.
  - **μ΅°κΈ° μΆ…λ£ (Early Stopping)**: κ²€μ¦ μ†μ‹¤μ΄ μΌμ • κΈ°κ°„ κ°μ„ λμ§€ μ•μΌλ©΄ ν•™μµμ„ μλ™μΌλ΅ μ¤‘λ‹¨ν•μ—¬ λ¶ν•„μ”ν• μ‹κ°„κ³Ό λ¦¬μ†μ¤ λ‚­λΉ„λ¥Ό λ°©μ§€ν•©λ‹λ‹¤.

-----

## π› οΈ μ‹¤ν–‰ ν™κ²½ μ„¤μ •

### 1\. ν•„μ” λΌμ΄λΈλ¬λ¦¬ μ„¤μΉ

μ΄ μ¤ν¬λ¦½νΈλ¥Ό μ‹¤ν–‰ν•κΈ° μ„ν•΄ ν•„μ”ν• μ£Όμ” λΌμ΄λΈλ¬λ¦¬λ” λ‹¤μκ³Ό κ°™μµλ‹λ‹¤. `requirements.txt` νμΌμ„ ν†µν•΄ ν•λ²μ— μ„¤μΉν•  μ μμµλ‹λ‹¤.

```bash
pip install torch transformers datasets wandb optuna numpy matplotlib opencv-python accelerate
```

### 2\. λ°μ΄ν„°μ…‹ μ¤€λΉ„

μ¤ν¬λ¦½νΈκ°€ μμƒν•λ” λ°μ΄ν„°μ…‹ κµ¬μ΅°λ” λ‹¤μκ³Ό κ°™μµλ‹λ‹¤. `metadata.json` νμΌμ—λ” ν•™μµ λ° κ²€μ¦μ— μ‚¬μ©ν•  μ΄λ―Έμ§€μ™€ λ§μ¤ν¬ νμΌμ κ²½λ΅ μ •λ³΄κ°€ ν¬ν•¨λμ–΄μ•Ό ν•©λ‹λ‹¤.

```
/home/work/data/indo_walking/surface_masking/
β”β”€β”€ processed_dataset/
β”‚   β”β”€β”€ metadata.json
β”‚   β”β”€β”€ train/
β”‚   β”‚   β”β”€β”€ images/
β”‚   β”‚   β”‚   β””β”€β”€ *.jpg
β”‚   β”‚   β””β”€β”€ masks/
β”‚   β”‚       β””β”€β”€ *.png
β”‚   β””β”€β”€ valid/
β”‚       β”β”€β”€ images/
β”‚       β”‚   β””β”€β”€ *.jpg
β”‚       β””β”€β”€ masks/
β”‚           β””β”€β”€ *.png
β””β”€β”€ ...
```

  - **`metadata.json`**: ν•™μµ, κ²€μ¦ λ°μ΄ν„°μ νμΌ κ²½λ΅ λ©λ΅μ„ ν¬ν•¨ν•λ” JSON νμΌμ…λ‹λ‹¤.
  - **λ°μ΄ν„° κ²½λ΅**: μ¤ν¬λ¦½νΈ λ‚΄ `create_data_loaders` ν•¨μμ—μ„ λ°μ΄ν„°μ…‹μ κΈ°λ³Έ κ²½λ΅ (`/home/work/data/indo_walking/surface_masking/processed_dataset/metadata.json`)λ¥Ό μ„¤μ •ν•κ³  μμΌλ―€λ΅, μ‹¤μ  ν™κ²½μ— λ§κ² κ²½λ΅λ¥Ό μμ •ν•΄μ•Ό ν•©λ‹λ‹¤.

### 3\. GPU ν™κ²½ λ³€μ μ„¤μ •

μ¤ν¬λ¦½νΈ μƒλ‹¨μ—μ„ μ‚¬μ©ν•  GPU λ° λ¶„μ‚° ν†µμ‹  κ΄€λ ¨ ν™κ²½ λ³€μλ¥Ό μ„¤μ •ν•©λ‹λ‹¤.

```python
# μ‚¬μ©ν•  GPU λ²νΈ μ§€μ • (μ: 3, 4, 5λ² GPU)
os.environ["CUDA_VISIBLE_DEVICES"] = "3,4,5"

# NCCL P2P λ° InfiniBand ν†µμ‹  λΉ„ν™μ„±ν™” (μ•μ •μ„± ν™•λ³΄)
os.environ["NCCL_P2P_DISABLE"] = '1'
os.environ["NCCL_IB_DISABLE"] = '1'
```

  - `CUDA_VISIBLE_DEVICES`: μ‚¬μ©ν•κ³ μ ν•λ” GPUμ IDλ¥Ό μ‰Όν‘λ΅ κµ¬λ¶„ν•μ—¬ μ§€μ •ν•©λ‹λ‹¤. μ½”λ“ λ‚΄λ¶€μ—μ„λ” μ΄ GPUλ“¤μ΄ 0, 1, 2λ²μΌλ΅ μλ™ λ§¤ν•‘λ©λ‹λ‹¤.
  - `world_size`: μ‚¬μ©ν•  μ΄ GPU μμ™€ μΌμΉν•΄μ•Ό ν•©λ‹λ‹¤. (μ: "3,4,5"λ΅ μ„¤μ • μ‹ `world_size`λ” 3)

-----

## π€ μ‚¬μ© λ°©λ²•

μ¤ν¬λ¦½νΈλ” λ‘ κ°€μ§€ μ£Όμ” λ¨λ“λ΅ μ‹¤ν–‰ν•  μ μμµλ‹λ‹¤.

1.  **ν•μ΄νΌνλΌλ―Έν„° μµμ ν™” ν›„ μµμΆ… ν•™μµ μ§„ν–‰ (κΈ°λ³Έκ°’)**

      - `Optuna`λ¥Ό μ‚¬μ©ν•μ—¬ μµμ μ ν•μ΄νΌνλΌλ―Έν„°λ¥Ό μ°Ύκ³ , κ·Έ κ²°κ³Όλ¥Ό `best_hyperparams.json` νμΌμ— μ €μ¥ν•©λ‹λ‹¤.
      - μ €μ¥λ μµμ μ νλΌλ―Έν„°λ΅ μ „μ²΄ λ°μ΄ν„°μ…‹(ν•™μµ+κ²€μ¦)μ„ μ‚¬μ©ν•μ—¬ μµμΆ… λ¨λΈμ„ ν•™μµν•©λ‹λ‹¤.
      - μµμΆ… ν•™μµλ λ¨λΈμ€ `final_ckpts/best_model.pth` κ²½λ΅μ— μ €μ¥λ©λ‹λ‹¤.

    <!-- end list -->

    ```bash
    python train_ddp_hyperopt_fixed.py
    ```

2.  **ν•μ΄νΌνλΌλ―Έν„° μµμ ν™” κ±΄λ„λ›°κ³  μµμΆ… ν•™μµλ§ μ§„ν–‰**

      - `--skip-hyperopt` ν”λκ·Έλ¥Ό μ‚¬μ©ν•μ—¬ μµμ ν™” λ‹¨κ³„λ¥Ό κ±΄λ„λ›Έ μ μμµλ‹λ‹¤.
      - μ΄ κ²½μ°, `--hyperparams-file` μΈμλ΅ μ§€μ •λ κ²½λ΅μ JSON νμΌμ„ μ½μ–΄μ™€ μµμΆ… ν•™μµμ„ μ§„ν–‰ν•©λ‹λ‹¤. (κΈ°λ³Έκ°’: `best_hyperparams.json`)
      - κΈ°μ΅΄μ— μ°Ύμ•„λ‘” μµμ μ νλΌλ―Έν„°κ°€ μλ‹¤λ©΄ μ΄ λ°©λ²•μ„ μ‚¬μ©ν•μ—¬ ν•™μµμ„ μ¬ν„ν•  μ μμµλ‹λ‹¤.

    <!-- end list -->

    ```bash
    # best_hyperparams.json νμΌμ„ μ‚¬μ©ν•μ—¬ μµμΆ… ν•™μµ μ‹¤ν–‰
    python train_ddp_hyperopt_fixed.py --skip-hyperopt

    # λ‹¤λ¥Έ μ΄λ¦„μ ν•μ΄νΌνλΌλ―Έν„° νμΌμ„ μ‚¬μ©ν•λ ¤λ©΄
    python train_ddp_hyperopt_fixed.py --skip-hyperopt --hyperparams-file my_best_params.json
    ```

-----

## π“ μ½”λ“ μ£Όμ” κµ¬μ„± μ”μ†

  - **`main()`**: ν”„λ΅κ·Έλ¨μ μ§„μ…μ μΌλ΅, μ»¤λ§¨λ“ λΌμΈ μΈμλ¥Ό νμ‹±ν•μ—¬ ν•μ΄νΌνλΌλ―Έν„° μµμ ν™” λλ” μµμΆ… ν•™μµμ„ μ μ–΄ν•©λ‹λ‹¤.

  - **`run_hyperparameter_optimization()`**: `Optuna` μ¤ν„°λ””λ¥Ό μƒμ„±ν•κ³  `objective` ν•¨μλ¥Ό μ‹¤ν–‰ν•μ—¬ μµμ μ ν•μ΄νΌνλΌλ―Έν„° μ΅°ν•©μ„ νƒμƒ‰ν•©λ‹λ‹¤.

  - **`objective(trial)`**: `Optuna`μ κ° `trial`(μ‹λ„)μ— λ€ν•΄ ν•μ΄νΌνλΌλ―Έν„° κ°’μ„ μƒν”λ§ν•κ³ , `hyperopt_wrapper`λ¥Ό νΈμ¶ν•μ—¬ λ¨λΈ ν•™μµ λ° κ²€μ¦ μ†μ‹¤μ„ λ°ν™ν•©λ‹λ‹¤.

  - **`run_final_training(best_hyperparams)`**: μµμ ν™”λ ν•μ΄νΌνλΌλ―Έν„°λ¥Ό μ…λ ¥λ°›μ•„ `final_train_wrapper`λ¥Ό νΈμ¶ν•κ³  μµμΆ… λ¨λΈμ„ ν•™μµν•©λ‹λ‹¤.

  - **`train_model_with_hyperparams(...)`**: μ‹¤μ  λ¨λΈ ν•™μµ, κ²€μ¦, λ΅κΉ…, μ΅°κΈ° μΆ…λ£ λ“± ν•µμ‹¬ λ΅μ§μ„ μν–‰ν•λ” ν•¨μμ…λ‹λ‹¤. `is_hyperopt` ν”λκ·Έλ¥Ό ν†µν•΄ μµμ ν™”μ© ν•™μµ(μΌλ¶€ λ°μ΄ν„°λ§ μ‚¬μ©)κ³Ό μµμΆ… ν•™μµ(μ „μ²΄ λ°μ΄ν„° μ‚¬μ©)μ„ κµ¬λ¶„ν•©λ‹λ‹¤.

  - **`hyperopt_wrapper`, `final_train_wrapper`**: `multiprocessing`μ„ μ‚¬μ©ν•μ—¬ κ° GPUμ—μ„ λ³‘λ ¬λ΅ ν•™μµ ν”„λ΅μ„Έμ¤λ¥Ό μ‹¤ν–‰ν•κΈ° μ„ν• λνΌ(wrapper) ν•¨μμ…λ‹λ‹¤.

  - **`setup_ddp(rank, world_size)`**: λ¶„μ‚° ν•™μµ ν™κ²½μ„ μ΄κΈ°ν™”ν•©λ‹λ‹¤. κ° ν”„λ΅μ„Έμ¤(GPU)μ μμ„(`rank`)μ™€ μ΄ ν”„λ΅μ„Έμ¤ μ(`world_size`)λ¥Ό κΈ°λ°μΌλ΅ ν†µμ‹  κ·Έλ£Ήμ„ μ„¤μ •ν•©λ‹λ‹¤.

  - **`create_data_loaders(...)`**: ν•™μµ λ° κ²€μ¦μ© λ°μ΄ν„°μ…‹κ³Ό `DataLoader`λ¥Ό μƒμ„±ν•©λ‹λ‹¤. `DistributedSampler`λ¥Ό μ‚¬μ©ν•μ—¬ κ° GPUμ— λ°μ΄ν„°λ¥Ό λ¶„λ°°ν•©λ‹λ‹¤.

-----

## π“ κ²°κ³Όλ¬Ό

  - **`best_hyperparams.json`**: ν•μ΄νΌνλΌλ―Έν„° μµμ ν™” ν›„ κ°€μ¥ μ„±λ¥μ΄ μΆ‹μ•λ νλΌλ―Έν„° μ΅°ν•©μ΄ μ €μ¥λλ” JSON νμΌμ…λ‹λ‹¤.
  - **`final_ckpts/best_model.pth`**: μµμΆ… ν•™μµ μ™„λ£ ν›„ κ°€μ¥ μ°μν• κ²€μ¦ μ„±λ¥μ„ λ³΄μΈ λ¨λΈμ κ°€μ¤‘μΉ(state\_dict)κ°€ μ €μ¥λλ” νμΌμ…λ‹λ‹¤.
  - **`temp_ckpts/`**: ν•™μµ μ¤‘κ°„μ— μƒμ„±λλ” μ„μ‹ μ²΄ν¬ν¬μΈνΈ νμΌλ“¤μ΄ μ €μ¥λλ” λ””λ ‰ν† λ¦¬μ΄λ©°, μ¤ν¬λ¦½νΈ μΆ…λ£ μ‹ μλ™μΌλ΅ μ‚­μ λ©λ‹λ‹¤.